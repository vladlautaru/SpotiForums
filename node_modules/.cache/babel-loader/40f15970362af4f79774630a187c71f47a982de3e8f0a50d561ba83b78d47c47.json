{"ast":null,"code":"//  SPDX-License-Identifier: LGPL-2.1-or-later\n//  Copyright (c) 2015-2024 MariaDB Corporation Ab\n\n'use strict';\n\nconst Capabilities = require('../../../const/capabilities');\nconst Collations = require('../../../const/collations');\nconst ConnectionInformation = require('../../../misc/connection-information');\n\n/**\n * Parser server initial handshake.\n * see https://mariadb.com/kb/en/library/1-connecting-connecting/#initial-handshake-packet\n */\nclass InitialHandshake {\n  constructor(packet, info) {\n    //protocolVersion\n    packet.skip(1);\n    info.serverVersion = {};\n    info.serverVersion.raw = packet.readStringNullEnded();\n    info.threadId = packet.readUInt32();\n    let seed1 = packet.readBuffer(8);\n    packet.skip(1); //reserved byte\n\n    let serverCapabilities = BigInt(packet.readUInt16());\n    info.collation = Collations.fromIndex(packet.readUInt8());\n    info.status = packet.readUInt16();\n    serverCapabilities += BigInt(packet.readUInt16()) << 16n;\n    let saltLength = 0;\n    if (serverCapabilities & Capabilities.PLUGIN_AUTH) {\n      saltLength = Math.max(12, packet.readUInt8() - 9);\n    } else {\n      packet.skip(1);\n    }\n    if (serverCapabilities & Capabilities.MYSQL) {\n      packet.skip(10);\n    } else {\n      packet.skip(6);\n      serverCapabilities += BigInt(packet.readUInt32()) << 32n;\n    }\n    if (serverCapabilities & Capabilities.SECURE_CONNECTION) {\n      let seed2 = packet.readBuffer(saltLength);\n      info.seed = Buffer.concat([seed1, seed2]);\n    } else {\n      info.seed = seed1;\n    }\n    packet.skip(1);\n    info.serverCapabilities = serverCapabilities;\n\n    /**\n     * check for MariaDB 10.x replication hack , remove fake prefix if needed\n     * MDEV-4088: in 10.0+, the real version string maybe prefixed with \"5.5.5-\",\n     * to workaround bugs in Oracle MySQL replication\n     **/\n\n    if (info.serverVersion.raw.startsWith('5.5.5-')) {\n      info.serverVersion.mariaDb = true;\n      info.serverVersion.raw = info.serverVersion.raw.substring('5.5.5-'.length);\n    } else {\n      //Support for MDEV-7780 faking server version\n      info.serverVersion.mariaDb = info.serverVersion.raw.includes('MariaDB') || (serverCapabilities & Capabilities.MYSQL) === 0n;\n    }\n    if (serverCapabilities & Capabilities.PLUGIN_AUTH) {\n      this.pluginName = packet.readStringNullEnded();\n    } else {\n      this.pluginName = '';\n    }\n    ConnectionInformation.parseVersionString(info);\n  }\n}\nmodule.exports = InitialHandshake;","map":{"version":3,"names":["Capabilities","require","Collations","ConnectionInformation","InitialHandshake","constructor","packet","info","skip","serverVersion","raw","readStringNullEnded","threadId","readUInt32","seed1","readBuffer","serverCapabilities","BigInt","readUInt16","collation","fromIndex","readUInt8","status","saltLength","PLUGIN_AUTH","Math","max","MYSQL","SECURE_CONNECTION","seed2","seed","Buffer","concat","startsWith","mariaDb","substring","length","includes","pluginName","parseVersionString","module","exports"],"sources":["D:/Ale lui Vlad/Projects/SpotiForums/spotiforums/node_modules/mariadb/lib/cmd/handshake/auth/initial-handshake.js"],"sourcesContent":["//  SPDX-License-Identifier: LGPL-2.1-or-later\n//  Copyright (c) 2015-2024 MariaDB Corporation Ab\n\n'use strict';\n\nconst Capabilities = require('../../../const/capabilities');\nconst Collations = require('../../../const/collations');\nconst ConnectionInformation = require('../../../misc/connection-information');\n\n/**\n * Parser server initial handshake.\n * see https://mariadb.com/kb/en/library/1-connecting-connecting/#initial-handshake-packet\n */\nclass InitialHandshake {\n  constructor(packet, info) {\n    //protocolVersion\n    packet.skip(1);\n    info.serverVersion = {};\n    info.serverVersion.raw = packet.readStringNullEnded();\n    info.threadId = packet.readUInt32();\n\n    let seed1 = packet.readBuffer(8);\n    packet.skip(1); //reserved byte\n\n    let serverCapabilities = BigInt(packet.readUInt16());\n    info.collation = Collations.fromIndex(packet.readUInt8());\n    info.status = packet.readUInt16();\n    serverCapabilities += BigInt(packet.readUInt16()) << 16n;\n\n    let saltLength = 0;\n    if (serverCapabilities & Capabilities.PLUGIN_AUTH) {\n      saltLength = Math.max(12, packet.readUInt8() - 9);\n    } else {\n      packet.skip(1);\n    }\n    if (serverCapabilities & Capabilities.MYSQL) {\n      packet.skip(10);\n    } else {\n      packet.skip(6);\n      serverCapabilities += BigInt(packet.readUInt32()) << 32n;\n    }\n\n    if (serverCapabilities & Capabilities.SECURE_CONNECTION) {\n      let seed2 = packet.readBuffer(saltLength);\n      info.seed = Buffer.concat([seed1, seed2]);\n    } else {\n      info.seed = seed1;\n    }\n    packet.skip(1);\n    info.serverCapabilities = serverCapabilities;\n\n    /**\n     * check for MariaDB 10.x replication hack , remove fake prefix if needed\n     * MDEV-4088: in 10.0+, the real version string maybe prefixed with \"5.5.5-\",\n     * to workaround bugs in Oracle MySQL replication\n     **/\n\n    if (info.serverVersion.raw.startsWith('5.5.5-')) {\n      info.serverVersion.mariaDb = true;\n      info.serverVersion.raw = info.serverVersion.raw.substring('5.5.5-'.length);\n    } else {\n      //Support for MDEV-7780 faking server version\n      info.serverVersion.mariaDb =\n        info.serverVersion.raw.includes('MariaDB') || (serverCapabilities & Capabilities.MYSQL) === 0n;\n    }\n\n    if (serverCapabilities & Capabilities.PLUGIN_AUTH) {\n      this.pluginName = packet.readStringNullEnded();\n    } else {\n      this.pluginName = '';\n    }\n    ConnectionInformation.parseVersionString(info);\n  }\n}\n\nmodule.exports = InitialHandshake;\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"script","externalDependencies":[]}